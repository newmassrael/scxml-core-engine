<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCXML Interactive Visualizer</title>

    <!-- Favicon: State machine icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='30' cy='30' r='15' fill='%230969da' stroke='%23000' stroke-width='2'/><circle cx='70' cy='70' r='15' fill='%231a7f37' stroke='%23000' stroke-width='2'/><path d='M 40 35 L 60 65' stroke='%23000' stroke-width='3' marker-end='url(%23arrow)'/><defs><marker id='arrow' markerWidth='10' markerHeight='10' refX='9' refY='3' orient='auto' markerUnits='strokeWidth'><path d='M0,0 L0,6 L9,3 z' fill='%23000'/></marker></defs></svg>">

    <!-- GitHub Primer CSS (local) -->
    <link href="primer.css" rel="stylesheet">

    <!-- Custom Visualizer CSS -->
    <link href="visualizer.css" rel="stylesheet">

    <!-- D3.js for SVG rendering (local) -->
    <script src="d3.v7.min.js"></script>

    <!-- ELK.js for hierarchical layout (CDN) -->
    <script src="https://unpkg.com/elkjs@0.9.3/lib/elk.bundled.js"></script>
</head>
<body>
    <!-- Loading State -->
    <div id="loading-state" class="loading" style="display: block;"></div>

    <!-- Error Container -->
    <div id="error-container" style="display: none;"></div>

    <!-- Main Content -->
    <div id="main-content" class="container-lg p-4" style="display: none;">
        <!-- Sticky Header and Controls -->
        <div class="sticky-header">
            <!-- Header -->
            <div class="mb-3">
                <h1 class="h2">
                    SCXML Interactive Visualizer
                    <span id="test-id" class="Label Label--accent ml-2"></span>
                </h1>
                <p id="test-description" class="text-gray">
                    Step-by-step SCXML execution with real-time state diagram visualization
                </p>
            </div>

            <!-- Control Panel -->
            <div class="Box mb-3">
                <div class="Box-header">
                    <h3 class="Box-title">Execution Controls</h3>
                </div>
                <div class="Box-body d-flex flex-items-center">
                <button id="btn-step-back" class="btn btn-step">
                    ◀ Step Back
                </button>
                <span id="step-counter" class="mx-3 f3 text-bold color-fg-accent">
                    Step 0
                </span>
                <button id="btn-step-forward" class="btn btn-primary btn-step">
                    Step Forward ▶
                </button>
                <button id="btn-reset" class="btn ml-3">
                    Reset
                </button>
                <button id="btn-center-view" class="btn ml-2" title="Center diagram on active states">
                    Center View
                </button>
                
                <!-- Test Navigation -->
                <div class="ml-3" style="border-left: 1px solid var(--color-border); padding-left: 12px;">
                    <button id="btn-prev-test" class="btn btn-sm">
                        ◀ Prev Test
                    </button>
                    <button id="btn-next-test" class="btn btn-sm ml-2">
                        Next Test ▶
                    </button>
                </div>
                
                <div class="ml-3 flex-1">
                    <label class="text-small text-gray mb-1" style="display: block;">Raise Event:</label>
                    <div id="event-buttons-container" class="event-buttons-container">
                        <!-- Event buttons will be generated here -->
                    </div>
                </div>
                <div class="ml-auto text-small text-gray">
                    Keyboard: ← Back | → Forward | R Reset
                </div>
            </div>
        </div>
        </div>
        <!-- End Sticky Header -->

        <!-- State Diagram with Split View for Parent-Child Communication -->
        <div class="Box mb-3">
            <div class="Box-header">
                <h3 class="Box-title">State Diagram</h3>
                <!-- Breadcrumb Navigation (W3C SCXML 6.3: Parent-Child Navigation) -->
                <div id="breadcrumb-container" class="ml-3 d-flex flex-items-center text-small">
                    <span class="breadcrumb-item active">Parent</span>
                </div>
                <!-- Back Button (hidden by default) -->
                <button id="btn-back" class="btn btn-sm ml-auto" style="display: none;">
                    ← Back to Parent
                </button>
            </div>
            <div class="Box-body">
                <!-- Single View Container (default, no children) -->
                <div id="single-view-container">
                    <div id="state-diagram-single" class="diagram-container active"></div>
                </div>
            </div>
        </div>

        <!-- Fixed Bottom Panels Container -->
        <div id="bottom-panels-container" class="bottom-panels-fixed">
            <!-- Resize Handle -->
            <div id="panel-resize-handle" class="panel-resize-handle">
                <button id="panel-toggle-btn" class="panel-toggle-btn" title="Minimize/Maximize Panel">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 12l-5-5h10l-5 5z"/>
                    </svg>
                </button>
            </div>
            <!-- Side Panels Row -->
            <div class="d-flex mb-3">
                <!-- Event Queue Panel -->
                <div class="Box flex-1 mr-2">
                    <div class="Box-header">
                        <h4 class="Box-title">Event Queue</h4>
                    </div>
                    <div id="event-queue-panel" class="Box-body event-queue">
                        <h4>Internal Queue</h4>
                        <div class="event">Empty</div>
                        <h4 style="margin-top: 16px;">External Queue</h4>
                        <div class="event">Empty</div>
                    </div>
                </div>

                <!-- Scheduled Events Panel -->
                <div class="Box flex-1 mr-2">
                    <div class="Box-header">
                        <h4 class="Box-title">Scheduled Events</h4>
                    </div>
                    <div id="scheduled-events-panel" class="Box-body event-queue">
                        <div class="event">No scheduled events</div>
                    </div>
                </div>

                <!-- Data Model Panel -->
                <div class="Box flex-1 mr-2">
                    <div class="Box-header">
                        <h4 class="Box-title">Data Model</h4>
                    </div>
                    <div id="data-model-panel" class="Box-body data-model">
                        <div class="data-entry">No data model variables</div>
                    </div>
                </div>

                <!-- State Actions Panel -->
                <div class="Box flex-1 mr-2">
                    <div class="Box-header">
                        <h4 class="Box-title">State Actions</h4>
                    </div>
                    <div id="state-actions-panel" class="Box-body state-actions">
                        <div class="action-info">No states with actions</div>
                    </div>
                </div>

                <!-- Transition Info Panel -->
                <div class="Box flex-1">
                    <div class="Box-header">
                        <h4 class="Box-title">Transition Info</h4>
                    </div>
                    <div class="Box-body transition-info">
                        <!-- Transition List (all transitions) -->
                        <div id="transition-list-panel">
                            <div class="transition-hint">No transitions</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Execution Log -->
            <div class="Box">
                <div class="Box-header">
                    <h3 class="Box-title">Execution Log</h3>
                </div>
                <div id="log-panel" class="Box-body log-panel">
                    <div class="log-entry">Waiting for first step...</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-small text-gray">
            <p>
                SCXML Interactive Visualizer |
                <a href="https://www.w3.org/TR/scxml/" target="_blank">W3C SCXML Specification</a> |
                <a href="https://github.com/newmassrael/scxml-core-engine" target="_blank">GitHub Repository</a>
            </p>
        </div>
    </div>

    <!-- Logger (must load first for all modules including WASM) -->
    <script src="logger.js"></script>

    <!-- WASM Module Configuration -->
    <script>
        // Configure C++ log level via proper C++ function call
        var Module = {
            preRun: [],
            postRun: [function() {
                // Set C++ log level after WASM module loads
                const params = new URLSearchParams(window.location.search);
                const isDebugMode = params.has('debug');
                const logLevel = params.get('loglevel') || 'debug';

                // Determine C++ log level
                const cppLogLevel = isDebugMode ? logLevel : 'off';

                // Call C++ function to set spdlog level
                if (typeof Module._setSpdlogLevel === 'function') {
                    Module._setSpdlogLevel(Module.allocateUTF8(cppLogLevel));
                    logger.debug(`[WASM] C++ log level set to: ${cppLogLevel}`);
                } else {
                    console.warn('[WASM] setSpdlogLevel function not found');
                }
            }]
        };
    </script>

    <!-- WASM Module (will be generated by Emscripten) -->
    <script src="visualizer.js"></script>

    <!-- Shared Utilities (DRY Principle) -->
    <script src="utils.js"></script>
    <script src="test-list.js"></script>

    <!-- Visualizer Components -->
    <script src="visualizer-manager.js"></script>
    <script src="edge-direction-utils.js"></script>
    <script src="routing-state.js"></script>
    <script src="constraint-solver.js"></script>
    <script src="collision-detector.js"></script>

    <!-- Transition Layout Optimizer Modules -->
    <script src="optimizer/snap-calculator.js"></script>
    <script src="optimizer/path-utils.js"></script>
    <script src="optimizer/csp-solver.js"></script>
    <script src="optimizer/optimizer-core.js"></script>

    <!-- SCXML Visualizer Modules -->
    <script src="visualizer/action-formatter.js"></script>
    <script src="visualizer/invoke-formatter.js"></script>
    <script src="visualizer/node-builder.js"></script>
    <script src="visualizer/link-builder.js"></script>
    <script src="visualizer/layout-manager.js"></script>
    <script src="visualizer/path-calculator.js"></script>
    <script src="visualizer/renderer.js"></script>
    <script src="visualizer/focus-manager.js"></script>
    <script src="visualizer/interaction-handler.js"></script>
    <script src="visualizer/visualizer-core.js"></script>

    <!-- Execution Controller Modules -->
    <script src="controller/formatters.js"></script>
    <script src="controller/ui-updater.js"></script>
    <script src="controller/control-handler.js"></script>
    <script src="controller/breadcrumb-manager.js"></script>
    <script src="controller/controller-core.js"></script>

    <!-- Panel Controller (Resize and Minimize/Maximize) -->
    <script src="panel-controller.js"></script>

    <script src="main.js"></script>
</body>
</html>
