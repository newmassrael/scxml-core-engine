<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCXML Interactive Visualizer</title>

    <!-- Favicon: State machine icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='30' cy='30' r='15' fill='%230969da' stroke='%23000' stroke-width='2'/><circle cx='70' cy='70' r='15' fill='%231a7f37' stroke='%23000' stroke-width='2'/><path d='M 40 35 L 60 65' stroke='%23000' stroke-width='3' marker-end='url(%23arrow)'/><defs><marker id='arrow' markerWidth='10' markerHeight='10' refX='9' refY='3' orient='auto' markerUnits='strokeWidth'><path d='M0,0 L0,6 L9,3 z' fill='%23000'/></marker></defs></svg>">

    <!-- GitHub Primer CSS (local) -->
    <link href="primer.css?v=dd997b6" rel="stylesheet">

    <!-- Custom Visualizer CSS -->
    <link href="visualizer.css?v=dd997b6" rel="stylesheet">

    <!-- D3.js for SVG rendering (local) -->
    <script src="d3.v7.min.js?v=dd997b6"></script>

    <!-- ELK.js for hierarchical layout (CDN) -->
    <script src="https://unpkg.com/elkjs@0.9.3/lib/elk.bundled.js"></script>
</head>
<body>
    <!-- Loading State -->
    <div id="loading-state" class="loading" style="display: block;">
        Loading WASM module...
    </div>

    <!-- Error Container -->
    <div id="error-container" style="display: none;"></div>

    <!-- Main Content -->
    <div id="main-content" class="container-lg p-4" style="display: none;">
        <!-- Header -->
        <div class="mb-3">
            <h1 class="h2">
                SCXML Interactive Visualizer
                <span id="test-id" class="Label Label--accent ml-2"></span>
            </h1>
            <p class="text-gray">
                Step-by-step SCXML execution with real-time state diagram visualization
            </p>
        </div>

        <!-- Control Panel -->
        <div class="Box mb-3">
            <div class="Box-header">
                <h3 class="Box-title">Execution Controls</h3>
            </div>
            <div class="Box-body d-flex flex-items-center">
                <button id="btn-step-back" class="btn btn-step">
                    ◀ Step Back
                </button>
                <span id="step-counter" class="mx-3 f3 text-bold color-fg-accent">
                    Step 0
                </span>
                <button id="btn-step-forward" class="btn btn-primary btn-step">
                    Step Forward ▶
                </button>
                <button id="btn-reset" class="btn ml-3">
                    Reset
                </button>
                <div class="ml-3 flex-1">
                    <label class="text-small text-gray mb-1" style="display: block;">Raise Event:</label>
                    <div id="event-buttons-container" class="event-buttons-container">
                        <!-- Event buttons will be generated here -->
                    </div>
                </div>
                <div class="ml-auto text-small text-gray">
                    Keyboard: ← Back | → Forward | R Reset
                </div>
            </div>
        </div>

        <!-- State Diagram with Split View for Parent-Child Communication -->
        <div class="Box mb-3">
            <div class="Box-header">
                <h3 class="Box-title">State Diagram</h3>
                <!-- View Mode Toggle -->
                <div id="view-mode-toggle" class="ml-3" style="display: none;">
                    <button id="btn-view-tabs" class="btn btn-sm">Tab View</button>
                    <button id="btn-view-split" class="btn btn-sm btn-primary">Split View</button>
                </div>
            </div>
            <div class="Box-body">
                <!-- Split View Container (shown when child exists) -->
                <div id="split-view-container">
                    <div class="split-view">
                        <!-- Parent State Machine -->
                        <div class="split-panel parent-panel">
                            <div class="panel-header">Parent State Machine</div>
                            <div id="state-diagram-parent-split" class="diagram-container-split"></div>
                        </div>

                        <!-- Communication Panel -->
                        <div class="split-panel communication-panel">
                            <div class="panel-header">Communication</div>
                            <div id="communication-log" class="communication-log">
                                <div class="comm-entry comm-info">Waiting for invoke/send events...</div>
                            </div>
                        </div>

                        <!-- Child State Machines (with tabs for multiple children) -->
                        <div class="split-panel child-panel">
                            <div class="panel-header">
                                Child State Machines
                                <!-- Child Tabs -->
                                <nav id="child-tabs" class="child-tabs" style="display: none;">
                                    <!-- Tabs will be generated dynamically -->
                                </nav>
                            </div>
                            <div id="child-diagrams-container">
                                <!-- Child diagrams will be added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Single View Container (default, no children) -->
                <div id="single-view-container">
                    <div id="state-diagram-single" class="diagram-container active"></div>
                </div>
            </div>
        </div>

        <!-- Side Panels Row -->
        <div class="d-flex mb-3">
            <!-- Event Queue Panel -->
            <div class="Box flex-1 mr-2">
                <div class="Box-header">
                    <h4 class="Box-title">Event Queue</h4>
                </div>
                <div id="event-queue-panel" class="Box-body event-queue">
                    <h4>Internal Queue</h4>
                    <div class="event">Empty</div>
                    <h4 style="margin-top: 16px;">External Queue</h4>
                    <div class="event">Empty</div>
                </div>
            </div>

            <!-- Data Model Panel -->
            <div class="Box flex-1 mr-2">
                <div class="Box-header">
                    <h4 class="Box-title">Data Model</h4>
                </div>
                <div id="data-model-panel" class="Box-body data-model">
                    <div class="data-entry">No data model variables</div>
                </div>
            </div>

            <!-- State Actions Panel -->
            <div class="Box flex-1 mr-2">
                <div class="Box-header">
                    <h4 class="Box-title">State Actions</h4>
                </div>
                <div id="state-actions-panel" class="Box-body state-actions">
                    <div class="action-info">No states with actions</div>
                </div>
            </div>

            <!-- Transition Info Panel -->
            <div class="Box flex-1">
                <div class="Box-header">
                    <h4 class="Box-title">Transition Info</h4>
                </div>
                <div id="transition-info-panel" class="Box-body transition-info">
                    <div class="transition-hint">Click a transition to view details</div>
                </div>
            </div>
        </div>

        <!-- Execution Log -->
        <div class="Box mt-3">
            <div class="Box-header">
                <h3 class="Box-title">Execution Log</h3>
            </div>
            <div id="log-panel" class="Box-body log-panel">
                <div class="log-entry">Waiting for first step...</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-4 text-center text-small text-gray">
            <p>
                SCXML Interactive Visualizer |
                <a href="https://www.w3.org/TR/scxml/" target="_blank">W3C SCXML Specification</a> |
                <a href="https://github.com/newmassrael/scxml-core-engine" target="_blank">GitHub Repository</a>
            </p>
        </div>
    </div>

    <!-- WASM Module (will be generated by Emscripten) -->
    <script src="visualizer.js?v=dd997b6"></script>

    <!-- Visualizer Components -->
    <script src="visualizer-manager.js?v=dd997b6"></script>
    <script src="edge-direction-utils.js?v=dd997b6"></script>
    <script src="routing-state.js?v=dd997b6"></script>
    <script src="constraint-solver.js?v=dd997b6"></script>
    <script src="transition-layout-optimizer.js?v=dd997b6"></script>
    <script src="scxml-visualizer.js?v=dd997b6"></script>
    <script src="execution-controller.js?v=dd997b6"></script>
    <script src="main.js?v=dd997b6"></script>
</body>
</html>
