#!/usr/bin/env python3
# SPDX-License-Identifier: LGPL-2.1-or-later OR LicenseRef-SCE-Commercial
# SPDX-FileCopyrightText: Copyright (c) 2025 newmassrael

"""
Generate visualizer/test-list.js from tests/CMakeLists.txt

Zero Duplication: CMakeLists.txt W3C_AOT_TESTS is the single source of truth.
This script automatically generates the JavaScript test list for the visualizer.

Usage:
    python3 tools/generate_test_list.py [cmake_file] [output_file]

Default:
    python3 tools/generate_test_list.py tests/CMakeLists.txt visualizer/test-list.js
"""

import re
import sys
from pathlib import Path


def extract_w3c_aot_tests(cmake_file):
    """
    Extract W3C_AOT_TESTS list from CMakeLists.txt

    Args:
        cmake_file: Path to CMakeLists.txt

    Returns:
        List of test numbers (as strings, e.g., ['144', '403a', '403b'])
    """
    with open(cmake_file, 'r', encoding='utf-8') as f:
        content = f.read()

    # Find set(W3C_AOT_TESTS ...) block
    match = re.search(
        r'set\(W3C_AOT_TESTS\s+(.*?)\)',
        content,
        re.DOTALL
    )

    if not match:
        raise ValueError(f"W3C_AOT_TESTS not found in {cmake_file}")

    # Extract test numbers (handles numeric and alphanumeric like 403a, 403b)
    tests_str = match.group(1)
    tests = []

    # Remove comments (# ...) and extract tokens
    lines = tests_str.split('\n')
    for line in lines:
        # Remove comments
        line = re.sub(r'#.*', '', line)
        # Extract test numbers (digits or digits+letter)
        for token in line.split():
            if re.match(r'^\d+[a-z]?$', token):
                tests.append(token)

    return tests


def format_js_array(tests):
    """
    Format test list as JavaScript array

    Args:
        tests: List of test numbers

    Returns:
        Formatted JavaScript array string with proper line breaks
    """
    # Group tests by hundreds for readability
    grouped = []
    current_group = []
    current_hundred = None

    for test in tests:
        # Extract numeric part for grouping
        numeric_part = int(re.match(r'^(\d+)', test).group(1))
        hundred = numeric_part // 100

        if current_hundred is None:
            current_hundred = hundred

        if hundred != current_hundred:
            grouped.append(current_group)
            current_group = []
            current_hundred = hundred

        # Add quotes for alphanumeric tests (403a, 403b, etc.)
        if re.match(r'^\d+[a-z]$', test):
            current_group.append(f"'{test}'")
        else:
            current_group.append(test)

    if current_group:
        grouped.append(current_group)

    # Format as multi-line array
    lines = []
    for group in grouped:
        lines.append('    ' + ', '.join(group) + ',')

    # Remove trailing comma from last line
    if lines:
        lines[-1] = lines[-1].rstrip(',')

    return '\n'.join(lines)


def generate_test_list_js(tests):
    """
    Generate complete test-list.js content

    Args:
        tests: List of test numbers

    Returns:
        Complete JavaScript file content
    """
    js_array = format_js_array(tests)

    return f"""// SPDX-License-Identifier: LGPL-2.1-or-later OR LicenseRef-SCE-Commercial
// SPDX-FileCopyrightText: Copyright (c) 2025 newmassrael

/**
 * W3C SCXML Test List
 *
 * ⚠️ AUTO-GENERATED - DO NOT EDIT MANUALLY
 * Source: tests/CMakeLists.txt - W3C_AOT_TESTS
 * Generator: tools/generate_test_list.py
 *
 * Zero Duplication: This file is automatically generated from CMakeLists.txt.
 * To update the test list, modify tests/CMakeLists.txt and run:
 *     python3 tools/generate_test_list.py
 * Or rebuild with CMake (automatic generation via custom command).
 */

const W3C_TEST_LIST = [
{js_array}
];

/**
 * Get current test number from URL hash
 */
function getCurrentTestNumber() {{
    const params = {{}};
    const hash = window.location.hash.substring(1);

    hash.split('&').forEach(param => {{
        const [key, value] = param.split('=');
        if (key && value) {{
            params[key] = decodeURIComponent(value);
        }}
    }});

    return params.test;
}}

/**
 * Navigate to test by number
 */
function navigateToTest(testNumber) {{
    window.location.hash = `test=${{testNumber}}`;
    window.location.reload();
}}

/**
 * Get previous test number
 */
function getPreviousTest() {{
    const currentTest = getCurrentTestNumber();
    if (!currentTest) return null;

    const currentIndex = W3C_TEST_LIST.indexOf(currentTest);
    if (currentIndex === -1) {{
        const currentNum = parseInt(currentTest);
        const numIndex = W3C_TEST_LIST.indexOf(currentNum);
        if (numIndex > 0) {{
            return W3C_TEST_LIST[numIndex - 1];
        }}
        return null;
    }}

    if (currentIndex > 0) {{
        return W3C_TEST_LIST[currentIndex - 1];
    }}

    return null;
}}

/**
 * Get next test number
 */
function getNextTest() {{
    const currentTest = getCurrentTestNumber();
    if (!currentTest) return null;

    const currentIndex = W3C_TEST_LIST.indexOf(currentTest);
    if (currentIndex === -1) {{
        const currentNum = parseInt(currentTest);
        const numIndex = W3C_TEST_LIST.indexOf(currentNum);
        if (numIndex >= 0 && numIndex < W3C_TEST_LIST.length - 1) {{
            return W3C_TEST_LIST[numIndex + 1];
        }}
        return null;
    }}

    if (currentIndex < W3C_TEST_LIST.length - 1) {{
        return W3C_TEST_LIST[currentIndex + 1];
    }}

    return null;
}}

/**
 * Initialize test navigation buttons
 */
function initializeTestNavigation() {{
    const btnPrevTest = document.getElementById('btn-prev-test');
    const btnNextTest = document.getElementById('btn-next-test');

    if (btnPrevTest) {{
        const prevTest = getPreviousTest();
        if (prevTest) {{
            btnPrevTest.disabled = false;
            btnPrevTest.addEventListener('click', () => {{
                navigateToTest(prevTest);
            }});
        }} else {{
            btnPrevTest.disabled = true;
        }}
    }}

    if (btnNextTest) {{
        const nextTest = getNextTest();
        if (nextTest) {{
            btnNextTest.disabled = false;
            btnNextTest.addEventListener('click', () => {{
                navigateToTest(nextTest);
            }});
        }} else {{
            btnNextTest.disabled = true;
        }}
    }}

    console.log(`[Test Navigation] Current: ${{getCurrentTestNumber()}}, Prev: ${{getPreviousTest()}}, Next: ${{getNextTest()}}`);
}}

// Initialize on DOMContentLoaded
window.addEventListener('DOMContentLoaded', initializeTestNavigation);
"""


def main():
    """Main entry point"""
    # Parse arguments
    cmake_file = Path(sys.argv[1]) if len(sys.argv) > 1 else Path('tests/CMakeLists.txt')
    output_file = Path(sys.argv[2]) if len(sys.argv) > 2 else Path('visualizer/test-list.js')

    # Validate input file exists
    if not cmake_file.exists():
        print(f"Error: {cmake_file} not found", file=sys.stderr)
        sys.exit(1)

    # Extract tests
    try:
        tests = extract_w3c_aot_tests(cmake_file)
        print(f"Extracted {len(tests)} tests from {cmake_file}")
    except Exception as e:
        print(f"Error extracting tests: {e}", file=sys.stderr)
        sys.exit(1)

    # Generate JavaScript
    js_content = generate_test_list_js(tests)

    # Write output
    output_file.parent.mkdir(parents=True, exist_ok=True)
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(js_content)

    print(f"Generated {output_file} successfully")
    print(f"Test range: {tests[0]} - {tests[-1]}")


if __name__ == '__main__':
    main()
