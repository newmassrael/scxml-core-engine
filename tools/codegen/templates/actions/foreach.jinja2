// Foreach loop (AOT: delegated to JSEngine)
try {
    ::RSM::Validation::validateForeachAttributes("{{ action.array }}", "{{ action.item }}");
{% if action.actions and action.actions | length > 0 %}
    {
        // Execute foreach: array={{ action.array }}, item={{ action.item }}, index={{ action.index }}
        this->ensureJSEngine();
        auto& jsEngine = ::RSM::JSEngine::instance();
        // W3C SCXML 4.6: Use ForeachHelper for centralized error handling
        ::RSM::Common::ForeachHelper::executeForeachWithActions(
            jsEngine, sessionId_.value(),
            "{{ action.array }}", "{{ action.item }}", "{{ action.index }}",
            [&](size_t i) -> bool {
                (void)i;  // Iteration index available if needed
                // W3C SCXML 4.6: Track overall success of all actions in this iteration
                bool iterationSuccess = true;
{% set has_assign = namespace(value=False) %}
{% for body_action in action.actions %}
{% if body_action.type == 'assign' %}{% set has_assign.value = True %}{% endif %}
{% endfor %}
{% if has_assign.value %}                bool success = false;  // Shared by all assign actions in this iteration
{% endif %}
{% for body_action in action.actions %}
                // W3C SCXML 4.6: Execute child action {{ loop.index }}/{{ action.actions | length }}
                {% if body_action.type == 'assign' %}
                // Assign action: no block scope, success accessible in foreach lambda
                {% with action=body_action, in_foreach=True %}
                {% include 'actions/' + body_action.type + '.jinja2' %}
                {% endwith %}
                iterationSuccess = iterationSuccess && success;
                if (!iterationSuccess) {
                    LOG_DEBUG("Foreach: Action {{ loop.index }} (assign) failed, stopping loop (W3C SCXML 4.6)");
                    return false;  // Stop foreach on error
                }
                {% else %}
                // Non-assign action: no success tracking needed
                {
                    {% with action=body_action %}
                    {% include 'actions/' + body_action.type + '.jinja2' %}
                    {% endwith %}
                }
                {% endif %}
{% endfor %}
                return iterationSuccess;  // Return true only if all actions succeeded
            }
        );
    }
{% else %}
    {
        this->ensureJSEngine();
        auto& jsEngine = ::RSM::JSEngine::instance();
        ::RSM::Common::ForeachHelper::executeForeachWithoutBody(
            jsEngine, sessionId_.value(),
            "{{ action.array }}", "{{ action.item }}", "{{ action.index }}"
        );
    }
{% endif %}
} catch (const std::runtime_error&) {
    engine.raise(typename Engine::EventWithMetadata(Event::Error_execution));
}
