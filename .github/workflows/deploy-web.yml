name: Deploy Web Interface

on:
  push:
    branches: [ main ]
    paths:
      - 'tools/web/**'
      - 'rsm/**'
      - 'tests/w3c/InteractiveTestRunner.cpp'
      - '.github/workflows/deploy-web.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 3.1.51
        actions-cache-folder: 'emsdk-cache'
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build libspdlog-dev

    - name: Install Python Dependencies
      run: |
        pip install lxml jinja2

    - name: Generate AOT Test Headers
      run: |
        chmod +x tools/generate_aot_headers.sh
        ./tools/generate_aot_headers.sh build/tests/w3c_static_generated

    - name: Build WASM
      run: |
        echo "Building WASM with Emscripten..."
        chmod +x build_wasm.sh
        ./build_wasm.sh

        # Verify WASM files were created
        if [ ! -f "tools/web/visualizer.wasm" ]; then
          echo "Error: visualizer.wasm not found after build!"
          exit 1
        fi

        echo "WASM build completed successfully"
        ls -lh tools/web/visualizer.wasm tools/web/visualizer.js
    
    - name: Prepare Web Files
      run: |
        mkdir -p web_dist

        # Get commit hash for cache busting
        COMMIT_HASH=$(git rev-parse --short HEAD)
        echo "Deployment commit: $COMMIT_HASH"

        # Copy code generator files
        cp tools/web/index.html web_dist/
        cp tools/web/aot-template.js web_dist/

        # Deploy visualizer files using shared script (Single Source of Truth)
        chmod +x tools/scripts/deploy_visualizer.sh
        ./tools/scripts/deploy_visualizer.sh \
          web_dist \
          tools/web/visualizer.wasm \
          tools/web/visualizer.js

        # Add cache-busting query parameters to local files only (exclude external URLs)
        echo "Adding cache-busting parameters (commit: $COMMIT_HASH)..."
        sed -i '/src="http/! s|src="\([^"]*\.js\)"|src="\1?v='"$COMMIT_HASH"'"|g' web_dist/visualizer.html
        sed -i '/href="http/! s|href="\([^"]*\.css\)"|href="\1?v='"$COMMIT_HASH"'"|g' web_dist/visualizer.html

        # Copy W3C SCXML test resources (follow symlink)
        echo "Copying W3C SCXML test resources..."
        cp -rL resources web_dist/
        
        # Create README
        cat > web_dist/README.md << 'EOF'
        # SCXML Web Tools

        Online tools for SCXML state machine development.

        ## Tools

        ### 1. Code Generator (index.html)
        Generate optimized C++ code from SCXML state machine definitions.

        **Features:**
        - SCXML Validation against W3C SCXML 1.0 specification
        - Type-safe, zero-overhead C++ code generation
        - Real-time feedback and validation
        - Download generated code

        **Usage:**
        1. Paste your SCXML code in the input pane
        2. Click "Generate C++ Code"
        3. Download the generated C++ header file

        ### 2. Interactive Visualizer (visualizer.html)
        Step-by-step SCXML execution with real-time state diagram visualization.

        **Features:**
        - Time-travel debugging (step forward/backward)
        - Real-time state diagram with D3.js
        - Event queue and data model inspection
        - Execution log with W3C SCXML spec references
        - Parent-child state machine visualization (invoke support)

        **Usage:**
        - From Code Generator: Click "Visualize" button
        - Direct access: `visualizer.html#test=226` (W3C test number)
        - Custom SCXML: `visualizer.html#scxml=<base64>`

        ## Built with

        - Frontend: HTML, CSS, JavaScript
        - Visualization: D3.js force-directed graphs
        - SCXML Engine: W3C SCXML 1.0 compliant (WASM)

        ## About scxml-core-engine

        These tools are powered by [scxml-core-engine](https://github.com/newmassrael/scxml-core-engine),
        a C++ SCXML library with W3C compliance and code generation capabilities.
        EOF

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./web_dist
        destination_dir: codegen
        keep_files: true

    - name: Create Summary
      if: always()
      run: |
        echo "## Web Interface Deployed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Online Tool: https://newmassrael.github.io/scxml-core-engine/codegen/" >> $GITHUB_STEP_SUMMARY
