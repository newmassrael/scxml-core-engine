name: Deploy Web Interface

on:
  push:
    branches: [ main ]
    paths:
      - 'tools/web/**'
      - 'rsm/**'
      - 'tests/w3c/InteractiveTestRunner.cpp'
      - '.github/workflows/deploy-web.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 3.1.51
        actions-cache-folder: 'emsdk-cache'
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build libspdlog-dev
    
    - name: Build WASM
      run: |
        echo "Building WASM with Emscripten..."
        chmod +x build_wasm.sh
        ./build_wasm.sh
        
        # Verify WASM files were created
        if [ ! -f "tools/web/visualizer.wasm" ]; then
          echo "Error: visualizer.wasm not found after build!"
          exit 1
        fi
        
        echo "WASM build completed successfully"
        ls -lh tools/web/visualizer.wasm tools/web/visualizer.js
    
    - name: Prepare Web Files
      run: |
        mkdir -p web_dist
        
        # Copy all web interface files
        cp tools/web/index.html web_dist/
        cp tools/web/aot-template.js web_dist/
        cp tools/web/visualizer.html web_dist/
        cp tools/web/visualizer.css web_dist/
        cp tools/web/visualizer.js web_dist/
        cp tools/web/visualizer.wasm web_dist/
        cp tools/web/scxml-visualizer.js web_dist/
        cp tools/web/transition-layout-optimizer.js web_dist/
        cp tools/web/visualizer-manager.js web_dist/
        cp tools/web/execution-controller.js web_dist/
        cp tools/web/main.js web_dist/
        cp tools/web/primer.css web_dist/
        cp tools/web/d3.v7.min.js web_dist/
        cp tools/web/spec_references.json web_dist/
        
        # Copy W3C SCXML test resources (follow symlink)
        echo "Copying W3C SCXML test resources..."
        cp -rL resources web_dist/
        
        # Create README
        cat > web_dist/README.md << 'EOF'
        # SCXML Web Tools

        Online tools for SCXML state machine development.

        ## Tools

        ### 1. Code Generator (index.html)
        Generate optimized C++ code from SCXML state machine definitions.

        **Features:**
        - SCXML Validation against W3C SCXML 1.0 specification
        - Type-safe, zero-overhead C++ code generation
        - Real-time feedback and validation
        - Download generated code

        **Usage:**
        1. Paste your SCXML code in the input pane
        2. Click "Generate C++ Code"
        3. Download the generated C++ header file

        ### 2. Interactive Visualizer (visualizer.html)
        Step-by-step SCXML execution with real-time state diagram visualization.

        **Features:**
        - Time-travel debugging (step forward/backward)
        - Real-time state diagram with D3.js
        - Event queue and data model inspection
        - Execution log with W3C SCXML spec references
        - Parent-child state machine visualization (invoke support)

        **Usage:**
        - From Code Generator: Click "Visualize" button
        - Direct access: `visualizer.html#test=226` (W3C test number)
        - Custom SCXML: `visualizer.html#scxml=<base64>`

        ## Built with

        - Frontend: HTML, CSS, JavaScript
        - Visualization: D3.js force-directed graphs
        - SCXML Engine: W3C SCXML 1.0 compliant (WASM)

        ## About scxml-core-engine

        These tools are powered by [scxml-core-engine](https://github.com/newmassrael/scxml-core-engine),
        a C++ SCXML library with W3C compliance and code generation capabilities.
        EOF

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./web_dist
        destination_dir: codegen
        keep_files: true

    - name: Create Summary
      if: always()
      run: |
        echo "## Web Interface Deployed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Online Tool: https://newmassrael.github.io/scxml-core-engine/codegen/" >> $GITHUB_STEP_SUMMARY
