name: W3C SCXML Compliance Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      log-level:
        description: 'Log level for test execution'
        required: false
        default: 'error'
        type: choice
        options:
          - trace
          - debug
          - info
          - warn
          - error
          - off
      specific-tests:
        description: 'Specific test numbers (comma-separated, e.g., 531,518,519) or empty for all'
        required: false
        default: ''

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: W3C SCXML Test Suite
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write
      contents: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          g++ \
          meson \
          ninja-build \
          lld \
          ccache \
          pkg-config \
          libxml2-dev \
          libspdlog-dev \
          libfmt-dev \
          libboost-dev

    - name: Setup Problem Matchers
      run: |
        echo "::add-matcher::.github/problem-matchers/gcc.json"
        echo "::add-matcher::.github/problem-matchers/cmake.json"

    - name: Install Python Dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install -r tools/codegen/requirements.txt

    - name: Setup Emscripten (emsdk)
      run: |
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        ./emsdk install latest
        ./emsdk activate latest
        cd ..

    - name: Cache CMake Build
      uses: actions/cache@v4
      with:
        path: |
          build/CMakeCache.txt
          build/CMakeFiles
          build/_deps
        key: ${{ runner.os }}-cmake-${{ github.repository }}-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-cmake-${{ github.repository }}-

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Verify lld Installation
      run: |
        echo "=== Checking lld installation ==="
        which ld.lld || echo "Warning: ld.lld not found in PATH"
        ld.lld --version || echo "Warning: ld.lld version check failed"

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DCMAKE_CXX_COMPILER=g++ \
          -G Ninja

    - name: Build
      run: |
        echo "=== Starting build with timing ==="
        time cmake --build build --target w3c_test_cli --parallel $(nproc)

    - name: Verify Resources
      run: |
        if [ ! -d "resources" ]; then
          echo "Error: resources directory not found"
          exit 1
        fi
        txml_count=$(find resources -name '*.txml' | wc -l)
        test_dirs=$(find resources -mindepth 1 -maxdepth 1 -type d | wc -l)
        echo "Resources directory found:"
        echo "  - Test directories: $test_dirs"
        echo "  - TXML files: $txml_count"

    - name: Debug Environment
      run: |
        echo "=== Current Directory ==="
        pwd
        echo ""
        echo "=== Resources Directory Check ==="
        if [ -d "resources" ]; then
          echo "Resources found at: $(pwd)/resources"
          ls -la resources | head -n 10
        else
          echo "ERROR: resources directory not found!"
          echo "Directory contents:"
          ls -la
        fi
        echo ""
        echo "=== Build Directory ==="
        ls -lh build/tests/w3c_test_cli
        echo ""
        echo "=== Executable Check ==="
        file build/tests/w3c_test_cli
        echo ""
        echo "=== Library Dependencies ==="
        ldd build/tests/w3c_test_cli || echo "ldd failed or static binary"
        echo ""
        echo "=== Test Executable Help ==="
        build/tests/w3c_test_cli --help || echo "Failed to run --help"

    - name: Run W3C SCXML Test Suite
      run: |
        cd build/tests
        ulimit -c unlimited

        echo "=== Pre-execution Environment ==="
        echo "Current directory: $(pwd)"
        echo "Resources search from: $(pwd)"
        echo "Project root should be: $(pwd)/../.."
        ls -la ../../resources | head -n 5 || echo "../../resources not found"
        echo ""

        # Determine log level (workflow_dispatch input or default 'debug')
        LOG_LEVEL="${{ inputs.log-level || 'debug' }}"

        # Determine test arguments
        if [ -n "${{ inputs.specific-tests }}" ]; then
          # Convert comma-separated list to space-separated
          TEST_ARGS=$(echo "${{ inputs.specific-tests }}" | tr ',' ' ')
          echo "Running specific tests: $TEST_ARGS"
          echo "Command: env SPDLOG_LEVEL=$LOG_LEVEL ./w3c_test_cli $TEST_ARGS --output w3c_test_results.xml"
          echo ""
          env SPDLOG_LEVEL=$LOG_LEVEL ./w3c_test_cli $TEST_ARGS --output w3c_test_results.xml 2>&1 | tee w3c_test_output.log
          EXIT_CODE=${PIPESTATUS[0]}
        else
          echo "Running all tests"
          echo "Command: env SPDLOG_LEVEL=$LOG_LEVEL ./w3c_test_cli --output w3c_test_results.xml"
          echo ""
          env SPDLOG_LEVEL=$LOG_LEVEL ./w3c_test_cli --output w3c_test_results.xml 2>&1 | tee w3c_test_output.log
          EXIT_CODE=${PIPESTATUS[0]}
        fi

        echo ""
        echo "=== Test Execution Result ==="
        echo "Exit code: $EXIT_CODE"
        echo "Output log size: $(wc -l < w3c_test_output.log) lines"

        # Check for XML file in both locations (current dir and project root)
        if [ -f w3c_test_results.xml ]; then
          echo "SUCCESS: w3c_test_results.xml created in current directory"
          ls -lh w3c_test_results.xml
        elif [ -f ../../w3c_test_results.xml ]; then
          echo "SUCCESS: w3c_test_results.xml created in project root"
          ls -lh ../../w3c_test_results.xml
          # Move to build/tests for easier access by other steps
          cp ../../w3c_test_results.xml .
          echo "Copied to build/tests/ for artifact upload"
        else
          echo "ERROR: w3c_test_results.xml was not created!"
          echo ""
          echo "=== Last 50 lines of output ==="
          tail -n 50 w3c_test_output.log
        fi

        exit $EXIT_CODE
      continue-on-error: true

    - name: Analyze Crash (if occurred)
      if: always()
      run: |
        cd build/tests
        echo "=== Crash Analysis ==="
        if [ -f core ]; then
          echo "Core dump found!"
          gdb -batch -ex "bt" -ex "quit" ./w3c_test_cli core 2>&1 || echo "GDB not available"
        else
          echo "No core dump found"
        fi
        echo ""
        echo "=== Test Output Summary ==="
        if [ -f w3c_test_output.log ]; then
          echo "Log file size: $(wc -l < w3c_test_output.log) lines"
          echo "First 20 lines:"
          head -n 20 w3c_test_output.log
          echo ""
          echo "Last 30 lines:"
          tail -n 30 w3c_test_output.log
        else
          echo "No output log found"
        fi
        echo ""
        echo "=== XML Results Check ==="
        if [ -f w3c_test_results.xml ]; then
          echo "XML file found in current directory"
          head -n 20 w3c_test_results.xml
        elif [ -f ../../w3c_test_results.xml ]; then
          echo "XML file found in project root (expected location)"
          head -n 20 ../../w3c_test_results.xml
        else
          echo "XML file NOT found in either location - test execution likely failed early"
        fi

    - name: Upload Test Output Log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: w3c-test-output-log
        path: build/tests/w3c_test_output.log
        retention-days: 30
        if-no-files-found: warn

    - name: Publish Test Report
      uses: mikepenz/action-junit-report@v4
      if: always()
      with:
        report_paths: 'build/tests/w3c_test_results.xml'
        detailed_summary: true
        include_passed: true
        fail_on_failure: false
        check_name: 'W3C SCXML Test Results'
        summary: 'ðŸ“Š [View Detailed HTML Report](https://newmassrael.github.io/scxml-core-engine/test-results/test-results.html)'
        annotate_only: false

    - name: Upload Test Results Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: w3c-test-results
        path: build/tests/w3c_test_results.xml
        retention-days: 30

    - name: Generate HTML Report
      if: always()
      run: |
        # XML file is in build/tests (copied from project root if needed)
        if [ -f build/tests/w3c_test_results.xml ]; then
          echo "Generating HTML report from build/tests/w3c_test_results.xml"
          python3 tests/w3c/scripts/xml_to_html.py \
            build/tests/w3c_test_results.xml \
            build/tests/w3c_test_results.html

          # Create a clean directory with only HTML files for GitHub Pages
          mkdir -p gh-pages
          cp build/tests/w3c_test_results.html gh-pages/test-results.html
          cp build/tests/w3c_test_results.xml gh-pages/
          echo "HTML report and XML copied to gh-pages/"
        else
          echo "âŒ ERROR: w3c_test_results.xml not found - cannot generate HTML report"
          echo "GitHub Pages will not be updated"
        fi

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: always() && github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./gh-pages
        destination_dir: test-results
        keep_files: true

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: |
          build/CMakeFiles/*.log
          build/Testing/Temporary/
        retention-days: 7

    - name: Generate Test Summary
      if: always()
      run: |
        cd build/tests
        echo "## ðŸ“Š W3C SCXML Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View Detailed HTML Report](https://newmassrael.github.io/scxml-core-engine/test-results/test-results.html)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f w3c_test_results.xml ]; then
          total=$(grep -oP 'tests="\K[0-9]+' w3c_test_results.xml | head -1)
          failures=$(grep -oP 'failures="\K[0-9]+' w3c_test_results.xml | head -1)
          errors=$(grep -oP 'errors="\K[0-9]+' w3c_test_results.xml | head -1)
          passed=$((total - failures - errors))
          pass_rate=$(awk "BEGIN {printf \"%.1f\", ($passed / $total) * 100}")

          # Count tests by engine type (using classname)
          interpreter_total=$(grep -oP 'classname="W3C_Interpreter"' w3c_test_results.xml | wc -l)
          aot_total=$(grep -oP 'classname="W3C_AOT"' w3c_test_results.xml | wc -l)

          # Count passed tests by engine type (no failure tags)
          interpreter_passed=$(grep 'classname="W3C_Interpreter"' w3c_test_results.xml | grep -v '<failure' | wc -l)
          aot_passed=$(grep 'classname="W3C_AOT"' w3c_test_results.xml | grep -v '<failure' | wc -l)

          interpreter_failed=$((interpreter_total - interpreter_passed))
          aot_failed=$((aot_total - aot_passed))

          # Display engine-specific statistics
          echo "| Engine | Total | Passed | Failed |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Interpreter | $interpreter_total | $interpreter_passed | $interpreter_failed |" >> $GITHUB_STEP_SUMMARY
          if [ $aot_total -gt 0 ]; then
            echo "| AOT | $aot_total | $aot_passed | $aot_failed |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| **Total** | **$total** | **$passed** | **$((failures + errors))** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“ˆ Pass Rate:** ${pass_rate}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if (( $(echo "$pass_rate >= 80.0" | bc -l) )); then
            echo "ðŸ† **Status:** EXCELLENT - High W3C SCXML compliance!" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$pass_rate >= 60.0" | bc -l) )); then
            echo "ðŸ‘ **Status:** GOOD - Reasonable W3C SCXML compliance" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Status:** NEEDS IMPROVEMENT - Review failing tests" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ Test results file not found" >> $GITHUB_STEP_SUMMARY
        fi
